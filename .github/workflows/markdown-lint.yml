name: Markdown

on:
  workflow_call:
    inputs:
      lint-config:
        type: string
        required: false
        default: 'configs/md_lint_config.yml'
        description: Path to markdownlint config file (JSON, JSONC, or YML).
      link-check-config:
        type: string
        required: false
        default: 'configs/mlc_config.json'
        description: Path to markdown link check config file (JSON).
      ignore-files:
        type: string
        required: false
        description: |
          Comma or space separated list of file paths or glob patterns to ignore
          when running markdownlint (e.g. 'docs/*.md,README.md').
env:
  CALLER_DIR: 'caller-repository'
  WORKFLOW_DIR: 'workflows-and-actions-collection'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: Open-CMSIS-Pack/workflows-and-actions-collection
          path: ${{ env.WORKFLOW_DIR }}

      - name: Register markdownlint matcher
        run: echo "::add-matcher::workflows-and-actions-collection/configs/markdownlint.json"

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ github.event.repository.full_name }}
          path: ${{ env.CALLER_DIR }}

      - name: Determine lint config path
        id: lint-config-path
        run: |
          if [ "${{ inputs.lint-config }}" = "configs/md_lint_config.yml" ]; then
            echo "config_path=${{ env.WORKFLOW_DIR }}/${{ inputs.lint-config }}" >> $GITHUB_OUTPUT
          else
            echo "config_path=${{ env.CALLER_DIR }}/${{ inputs.lint-config }}" >> $GITHUB_OUTPUT
          fi

      - name: Prefix caller directory to ignore-files
        id: formatted-ignore
        run: |
          IGNORE_INPUT="${{ inputs.ignore-files }}"
          if [ -z "$IGNORE_INPUT" ]; then
            echo "result=" >> $GITHUB_OUTPUT
          else
            # Replace comma or space with newline, prefix each line, then join with commas
            FORMATTED=$(echo "$IGNORE_INPUT" | tr ', ' '\n' | sed "s|^|${{ env.CALLER_DIR }}/|" | paste -sd, -)
            echo "result=$FORMATTED" >> $GITHUB_OUTPUT
          fi

      - name: Run markdownlint
        uses: avto-dev/markdown-lint@04d43ee9191307b50935a753da3b775ab695eceb # v1.5.0
        with:
          args: ${{ env.CALLER_DIR }}/**/*.md
          config: ${{ steps.lint-config-path.outputs.config_path }}
          ignore: ${{ steps.formatted-ignore.outputs.result }}

      - name: Cleanup markdownlint matcher
        if: always()
        run: echo "::remove-matcher owner=markdownlint::"

  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check markdown links
        uses: tcort/github-action-markdown-link-check@a800ad5f1c35bf61987946fd31c15726a1c9f2ba # v1.1.0
        with:
          use-verbose-mode: 'yes'
          base-branch: ${{ github.base_ref }}
          config-file: ${{ inputs.link-check-config }}
