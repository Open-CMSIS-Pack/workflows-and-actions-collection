name: Markdown

on:
  workflow_call:
    inputs:
      lint-config:
        type: string
        required: false
        default: 'configs/md_lint_config.yml'
        description: Path to markdownlint config file (JSON, JSONC, or YML).
      link-check-config:
        type: string
        required: false
        default: 'configs/mlc_config.json'
        description: Path to markdown link check config file (JSON).
      ignore-files:
        type: string
        required: false
        description: |
          Comma or space separated list of file paths or glob patterns to ignore
          when running markdownlint (e.g. 'docs/*.md,README.md').
env:
  CALLER_DIR: 'caller-repository'
  WORKFLOW_DIR: 'workflows-and-actions-collection'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: Open-CMSIS-Pack/workflows-and-actions-collection
          path: ${{ env.WORKFLOW_DIR }}

      - name: Register markdownlint matcher
        run: echo "::add-matcher::workflows-and-actions-collection/configs/markdownlint.json"

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ github.event.repository.full_name }}
          path: ${{ env.CALLER_DIR }}

      - name: Determine lint config path
        id: lint-config-path
        run: |
          if [ "${{ inputs.lint-config }}" = "configs/md_lint_config.yml" ]; then
            echo "config_path=${{ env.WORKFLOW_DIR }}/${{ inputs.lint-config }}" >> $GITHUB_OUTPUT
          else
            echo "config_path=${{ env.CALLER_DIR }}/${{ inputs.lint-config }}" >> $GITHUB_OUTPUT
          fi

      - name: Prefix caller directory to ignore-files
        id: formatted-ignore
        run: |
          IGNORE_INPUT="${{ inputs.ignore-files }}"
          if [ -z "$IGNORE_INPUT" ]; then
            echo "result=" >> $GITHUB_OUTPUT
          else
            # Replace comma or space with newline, prefix each line, then join with commas
            FORMATTED=$(echo "$IGNORE_INPUT" | tr ', ' '\n' | sed "s|^|${{ env.CALLER_DIR }}/|" | paste -sd, -)
            echo "result=$FORMATTED" >> $GITHUB_OUTPUT
          fi

      - name: Run markdownlint
        uses: avto-dev/markdown-lint@04d43ee9191307b50935a753da3b775ab695eceb # v1.5.0
        with:
          args: ${{ env.CALLER_DIR }}/**/*.md
          config: ${{ steps.lint-config-path.outputs.config_path }}
          ignore: ${{ steps.formatted-ignore.outputs.result }}

      - name: Cleanup markdownlint matcher
        if: always()
        run: echo "::remove-matcher owner=markdownlint::"

  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ github.event.repository.full_name }}
          path: ${{ env.CALLER_DIR }}

      - name: Determine link check config path
        id: link-config-path
        run: |
          if [ "${{ inputs.link-check-config }}" = "configs/mlc_config.json" ]; then
            echo "config_path=${{ env.WORKFLOW_DIR }}/${{ inputs.link-check-config }}" >> $GITHUB_OUTPUT
          else
            echo "config_path=${{ env.CALLER_DIR }}/${{ inputs.link-check-config }}" >> $GITHUB_OUTPUT
          fi

      - name: list files to check
        working-directory: ${{ env.CALLER_DIR }}
        run: |
          ls -l

      - name: Upload test files as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: TEST-FILE
          path: ${{ env.CALLER_DIR }}/CONTRIBUTING.md

      - name: Check markdown links
        id: markdown-link-check
        uses: gaurav-nelson/github-action-markdown-link-check@1.0.15
        with:
          use-quiet-mode: 'no'
          use-verbose-mode: 'yes'
          config-file: ${{ steps.link-config-path.outputs.config_path }}

      - name: display errors
        run: |
          echo "${{ steps.markdown-link-check.outputs.MLC_OUTPUT }}"

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 20

      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      - name: Find and check all Markdown files
        run: |
          set -e
          echo "Checking markdown files recursively..."
          md_files=$(find . -name "*.md")
          if [ -z "$md_files" ]; then
            echo "‚ö†Ô∏è No Markdown files found."
            exit 1
          fi

          failed=0
          for file in $md_files; do
            echo "üìÑ Checking $file"
            if ! markdown-link-check "$file" --verbose; then
              echo "‚ùå Broken links found in $file"
              failed=1
            fi
          done

          if [ "$failed" -ne 0 ]; then
            echo "üõë Broken links detected in one or more Markdown files"
            exit 1
          else
            echo "‚úÖ All links are valid"
          fi

